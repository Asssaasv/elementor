name: Playwright

on:
  pull_request:
  schedule:
    - cron: '30 08 * * 0,1,2,3,4,5'
  workflow_dispatch:
      inputs:
        reporter:
          required: false
          description: 'Select a reporter'
          type: choice
          options:
            - allure-playwright
            - html
            - blob
            - list
          default: allure-playwright
        path-to-results:
          required: false
          description: 'Provide path to reporter files'
          default: allure-results
          type: choice
          options:
            - test-results/
            - tests/playwright/blob-report
            - allure-results
        fail_fast:
            type: boolean
            required: true
            description: 'Cancel tests when one of them fails'
            default: false

# This allows a subsequently queued workflow run to interrupt previous runs
concurrency:
  group: '${{ github.workflow }} @ ${{ github.event.pull_request.head.label || github.head_ref || github.ref }}'
  cancel-in-progress: true

jobs:
  build-plugin:
    name: Build plugin
    uses: ./.github/workflows/build.yml

  trigger-pro-workflow:
    name: Trigger Pro Workflow
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'trigger-pro-tests')
    steps:
      - name: Trigger Elementor Pro Playwright Workflow
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: playwright-custom-core.yml
          repo: elementor/elementor-pro
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Track Remote Workflow
        uses: benc-uk/workflow-dispatch@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          repo: elementor/elementor-pro
          workflow: Playwright - Custom Core
          ref: main
          check_status: true
#  test-result:
#    needs: Playwright
#    if: ${{ always() }} # Will be run even if 'Playwright' matrix will be skipped
#    runs-on: ubuntu-22.04
#    name: Playwright - Test Results
#    steps:
#      - name: Test status
#        run: echo "Test status is - ${{ needs.Playwright.result }}"
#      - name: Checkout source code
#        if: ${{ needs.Playwright.result == 'failure' && github.event_name == 'schedule' }}
#        uses: actions/checkout@v4
#      - name: Send slack message
#        if: ${{ needs.Playwright.result == 'failure' && github.event_name == 'schedule' }}
#        uses: ./.github/workflows/post-to-slack
#        with:
#          SLACK_BOT_TOKEN: ${{ secrets.SLACK_TOKEN }}
#          SLACK_TAG_CHANNELS: ${{ secrets.TEST_AUTOMATION_RESULTS }}
#          PAYLOAD: |
#            {
#              "text": "Elementor Core: Playwright with WordPress nightly has failed: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
#              "blocks": [
#                {
#                  "type": "section",
#                  "text": {
#                    "type": "mrkdwn",
#                    "text": "Elementor Core: Playwright with WordPress nightly failed: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
#                  }
#                }
#              ]
#            }
#      - name: Check Playwright matrix status
#        if: ${{ needs.Playwright.result != 'success' && needs.Playwright.result != 'skipped' }}
#        run: exit 1
